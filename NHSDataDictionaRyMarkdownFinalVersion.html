<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>NHSDataDictionaRy Workshop</title>
    <meta charset="utf-8" />
    <meta name="author" content="Gary Hutson - Senior Data Scientist" />
    <meta name="date" content="2021-04-10" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <script src="libs/htmlwidgets-1.5.4/htmlwidgets.js"></script>
    <script src="libs/plotly-binding-4.10.0/plotly.js"></script>
    <script src="libs/typedarray-0.1/typedarray.min.js"></script>
    <script src="libs/jquery-3.5.1/jquery.min.js"></script>
    <link href="libs/crosstalk-1.1.1/css/crosstalk.css" rel="stylesheet" />
    <script src="libs/crosstalk-1.1.1/js/crosstalk.min.js"></script>
    <link href="libs/plotly-htmlwidgets-css-2.5.1/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="libs/plotly-main-2.5.1/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="css/mango.css" type="text/css" />
    <link rel="stylesheet" href="css/mango-fonts.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# NHSDataDictionaRy Workshop
## NHS-R Community
### Gary Hutson - Senior Data Scientist
### 04/10/2021

---





## Introduction

.pull-left[
Welcome to the NHSDataDictionaRy workshop. Today we will learn how to work with the data dictionary for NHS lookup tasks, as well as how to extend the package to work with any website. The concentration of the workshop will be broken down as such:

- Getting familiar with the NHSDataDictionaRy package and all the underlying functions
- Understanding the [nhs_data_elements()](https://rdrr.io/cran/NHSDataDictionaRy/man/nhs_data_elements.html) elements function and how to filter on this
- Gather text from any website and perform some text cleaning operations on the text, using a combination of functions contained in the package
- Using the [TableR](https://rdrr.io/cran/NHSDataDictionaRy/man/tableR.html) function to retrieve HTML tables from the data dictionary site and then extending this to other websites
- Working with XPath website elements with the [NHSDataDictionaRy package](https://cran.r-project.org/web/packages/NHSDataDictionaRy/vignettes/introduction.html)

]

.pull-right[
   &lt;a href="https://cran.r-project.org/web/packages/NHSDataDictionaRy/"&gt;&lt;img src = "man/figures/NHSDataDict.png"&gt;&lt;/a&gt;
]

---
## Watch our previous webinar on how to use this package
This was taken from a webinar we recorded a how to guide from the launch of the NHSDataDictionaRy package. This may be useful for referring to, but most of what is covered in the video will be in today's workshop. 
&lt;br&gt;&lt;/br&gt;


&lt;iframe width="600" height="400" src="https://www.youtube.com/embed/MqCFHCbTORs" align="left" title="NHSDataDictionaRy tutorial" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen&gt;&lt;/iframe&gt;


---
class: inverse, middle, left, hide-logo
# Loading libraries

---
# Loading libraries in NHSDataDictionaRy package

To load the libraries needed for this session you will need to bring in the following:


```r
library(NHSDataDictionaRy)
```

This will bring in the libraries needed to work with the package. The next step would be to check the dependencies in the package: 


```r
packrat:::recursivePackageDependencies("NHSDataDictionaRy", lib.loc = .libPaths())
```

```
##  [1] "R6"         "askpass"    "cli"        "crayon"     "curl"      
##  [6] "dplyr"      "ellipsis"   "fansi"      "generics"   "glue"      
## [11] "httr"       "jsonlite"   "lifecycle"  "magrittr"   "mime"      
## [16] "openssl"    "pillar"     "pkgconfig"  "purrr"      "rlang"     
## [21] "rvest"      "selectr"    "stringi"    "stringr"    "sys"       
## [26] "tibble"     "tidyselect" "utf8"       "vctrs"      "xml2"
```

---
class: inverse, middle, left, hide-logo
# Working with the TableR, nhs_data_elements and nhs_tableR functions

---
# Starting with the nhs_data_elements() function

To retrieve the list of currrent NHS lookups in the table finder we use the underlying function:


```r
nhs_data_table &lt;- nhs_data_elements()
```

This function will then return the full list of data elements the package has scraped from the [NHS Data Dictionary website](https://www.datadictionary.nhs.uk/). 

An example of what has been scraped is on the next slide.

---

# Working with the scraped values

These scraped values will allow us to access the XPath elements of the website directly (don't worry if you don't know what an XPath is, we will get to that later on). To pull down a lookup table using the nhs_data_elements master reference we can use the TableR function to achieve this:

## Getting the Activity Treatment Function Codes


```r
# Filter the table
act_treatment_function &lt;- nhs_data_table %&gt;% 
  dplyr::filter(link_name == "ACTIVITY TREATMENT FUNCTION CODE") 
```

On the next slide you will see this has returned the lookup that I require:

---


```r
# Use the TableR function to pull back the data table
act_treat_lookup &lt;- NHSDataDictionaRy::tableR(url=act_treatment_function$full_url,
                          xpath=act_treatment_function$xpath_nat_code,
                          title="NHS Hospital Activity Treatment Function Code")

print(head(act_treat_lookup,5))
```

```
## # A tibble: 5 x 4
##   Code  Description                Dict_Type                 DttmExtracted      
##   &lt;chr&gt; &lt;chr&gt;                      &lt;chr&gt;                     &lt;dttm&gt;             
## 1 100   General Surgery Service    NHS Hospital Activity Tr~ 2021-11-03 08:58:46
## 2 101   Urology Service            NHS Hospital Activity Tr~ 2021-11-03 08:58:46
## 3 102   Transplant Surgery Service NHS Hospital Activity Tr~ 2021-11-03 08:58:46
## 4 103   Breast Surgery Service     NHS Hospital Activity Tr~ 2021-11-03 08:58:46
## 5 104   Colorectal Surgery Service NHS Hospital Activity Tr~ 2021-11-03 08:58:46
```
This lookup will return the lookup table needed.
---
## What if the element is not returned?

I include an example of when an element is not returned, as not all elements from the list have corresponding HTML data tables to extract. A worked example is below:


```r
# Filter the table
abb_ment_test_score &lt;- nhs_data_table %&gt;% 
  dplyr::filter(link_name == "ABBREVIATED MENTAL TEST SCORE") 

# This will show a NULL return, as there is no HTML table present
null_output &lt;- NHSDataDictionaRy::tableR(abb_ment_test_score$full_url,
                          abb_ment_test_score$xpath_nat_code)
```

```
## HTML Table does not exist for this URL.
## Check the URL online at:
## https://datadictionary.nhs.uk/data_elements/abbreviated_mental_test_score.html.
```
This shows a ***NULL*** return, as there is no HTML present for the national code specified. This can be highlighted by using the NHS Data Dictionary website to highlight this.

---
## Checking the NHS Data Dictionary website

.pull-left[
&lt;img src="man/figures/NHSWebsiteDD1.png" alt="drawing" width="700" height="300"/&gt;
]

.pull-right[
You can see that the website contains no national code table, thus the message.

You will not be able to retrieve these elements from the site, so the package presents you with a warning that these HTML table tables do not exist. 

This is supposed to be informative and will allow you then to quickly inspect other items of interest.

]

---
background-image: url(man/figures/practice.jpg)
# Practice time - 10 minutes
Have a go at extracting elements from the nhs_data_elements() and TableR functions.

---
# Introducing a quicker way to retrieve elements

Until now we have been working long hand and finding with retrieving the list of lookups and then using the TableR function. There is a more simple function in the package to use to do this, but I wanted to get you familiar with using the returned elements such as the URL and XPath, because we will come on to this again later.

## nhs_table_findeR to the rescue


```r
tfc &lt;- NHSDataDictionaRy::nhs_table_findeR("ACTIVITY TREATMENT FUNCTION CODE",
                                           title="Treatment Function Code")

glimpse(tfc)
```

```
## Rows: 184
## Columns: 4
## $ Code          &lt;chr&gt; "100", "101", "102", "103", "104", "105", "106", "107", ~
## $ Description   &lt;chr&gt; "General Surgery Service", "Urology Service", "Transplan~
## $ Dict_Type     &lt;chr&gt; "Treatment Function Code", "Treatment Function Code", "T~
## $ DttmExtracted &lt;dttm&gt; 2021-11-03 08:58:46, 2021-11-03 08:58:46, 2021-11-03 08~
```

This function replaces the convoluted code we used earlier. 

---
## Using the lookup to join on to hospital data
We have this lookup and now we will generate some hospital data to match with our lookups:

```r
set.seed(123)
spec_code &lt;- rep(as.character(c(101,102,103,104,105,106,107, 108)), 12)
attends &lt;- round(rnorm(length(spec_code), 500, 50))
breaches &lt;- round(rnorm(length(spec_code), 40, 3))
admits &lt;- round(rnorm(length(spec_code), 300, 20))
month &lt;- rep(c("Jan", "Feb", "March", "April", "May", "Jun", "July", "Aug", "Sept",
               "Oct", "Nov", "Dec"),8)
# Combine these atomic vectors into tibble
ed_act_by_month &lt;- tibble(spec_code, attends, breaches, admits, month)
glimpse(ed_act_by_month)
```

```
## Rows: 96
## Columns: 5
## $ spec_code &lt;chr&gt; "101", "102", "103", "104", "105", "106", "107", "108", "101~
## $ attends   &lt;dbl&gt; 472, 488, 578, 504, 506, 586, 523, 437, 466, 478, 561, 518, ~
## $ breaches  &lt;dbl&gt; 47, 45, 39, 37, 38, 41, 39, 39, 37, 40, 38, 35, 39, 43, 38, ~
## $ admits    &lt;dbl&gt; 302, 282, 274, 340, 312, 275, 288, 276, 344, 326, 295, 311, ~
## $ month     &lt;chr&gt; "Jan", "Feb", "March", "April", "May", "Jun", "July", "Aug",~
```


---
## Using our custom data to join our lookups

Now we have some data to match, we can join our dynamic lookup from the web on to the lookup:


```r
# Get our tfc and we are going to join this to specialty code
joined_activity = ed_act_by_month %&gt;% 
  dplyr::left_join(tfc, by = c("spec_code"="Code")) %&gt;% 
  dplyr::select(everything(), -c(Dict_Type, DttmExtracted))

glimpse(joined_activity)
```

```
## Rows: 96
## Columns: 6
## $ spec_code   &lt;chr&gt; "101", "102", "103", "104", "105", "106", "107", "108", "1~
## $ attends     &lt;dbl&gt; 472, 488, 578, 504, 506, 586, 523, 437, 466, 478, 561, 518~
## $ breaches    &lt;dbl&gt; 47, 45, 39, 37, 38, 41, 39, 39, 37, 40, 38, 35, 39, 43, 38~
## $ admits      &lt;dbl&gt; 302, 282, 274, 340, 312, 275, 288, 276, 344, 326, 295, 311~
## $ month       &lt;chr&gt; "Jan", "Feb", "March", "April", "May", "Jun", "July", "Aug~
## $ Description &lt;chr&gt; "Urology Service", "Transplant Surgery Service", "Breast S~
```


---
background-image: url(man/figures/practice.jpg)
# Practice time - 10 minutes
Try joining the main specialty code to this data

---
## Practice solution
This is pretty simple really - I just need to use the nhs_table_findeR function to get my lookup, if you are not sure what the string is to pass, use the nhs_data_elements() function to get all the strings. 


```r
main_spec &lt;- NHSDataDictionaRy::nhs_table_findeR("CARE PROFESSIONAL MAIN SPECIALTY CODE",
                                    title="Main Specialty")

# Join our main specialty on to the ed_act_by_month tibble
main_spec_with_act &lt;- ed_act_by_month %&gt;% 
  dplyr::left_join(main_spec, by= c("spec_code"="Code")) %&gt;% 
  dplyr::select(everything(), -c(Dict_Type, DttmExtracted))

glimpse(main_spec_with_act)
```

```
## Rows: 96
## Columns: 6
## $ spec_code   &lt;chr&gt; "101", "102", "103", "104", "105", "106", "107", "108", "1~
## $ attends     &lt;dbl&gt; 472, 488, 578, 504, 506, 586, 523, 437, 466, 478, 561, 518~
## $ breaches    &lt;dbl&gt; 47, 45, 39, 37, 38, 41, 39, 39, 37, 40, 38, 35, 39, 43, 38~
## $ admits      &lt;dbl&gt; 302, 282, 274, 340, 312, 275, 288, 276, 344, 326, 295, 311~
## $ month       &lt;chr&gt; "Jan", "Feb", "March", "April", "May", "Jun", "July", "Aug~
## $ Description &lt;chr&gt; "Urology", NA, NA, NA, NA, NA, "Vascular Surgery", NA, "Ur~
```


---
class: inverse, middle, left, hide-logo
# Wider use cases of the web scraping potential

---
## Scraping the Championship Football table
We could use the tableR function to scrape the results of the Championship table, here we will have to do some text processing as well to clean this up. I want to see how good or bad my team Nottingham Forest are doing.To get the Xpath I will need to use the Inspect button in google to copy this:

&lt;img src="man/figures/football_gif.gif" alt="drawing" height="350px" width="700px"/&gt;

---
### Using the retrieved Xpath from Google

The next step would be to copy the xpath and url into a variable, so we can differentiate them later.


```r
football_xpath &lt;- '//*[@id="u16945876197938725"]/div/div[2]/div/div/div[2]/div/div/table'
url &lt;- "https://www.bbc.co.uk/sport/football/championship/table"
```

Now let's get the HTML table from the website. Important to note that if it does not end in **/table** at the end of the url then it cannot be used with the TableR function, as it is not an HTML table object. 


```r
football_table &lt;- NHSDataDictionaRy::tableR(url=url, 
                          xpath=football_xpath,
                          title="English Championship League Standings")

head(football_table, 3)
```

```
## # A tibble: 3 x 14
##   V1    V2     Team   P     W     D     L     F     A     GD    Pts   Form      
##   &lt;chr&gt; &lt;chr&gt;  &lt;chr&gt;  &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt; &lt;chr&gt;     
## 1 1     team ~ Bourn~ 15    11    4     0     26    8     18    37    WWon 2 - ~
## 2 2     team ~ Fulham 15    10    2     3     36    14    22    32    LLost 1 -~
## 3 3     team ~ West ~ 15    8     4     3     25    14    11    28    LLost 0 -~
## # ... with 2 more variables: Dict_Type &lt;chr&gt;, DttmExtracted &lt;dttm&gt;
```

---
### Let's clean the table up
The first stage would be to drop some of the less informative columns:


```r
# Convert to integer
ftball_reduced &lt;- football_table %&gt;% 
  dplyr::select(-c(V1, V2, Form, Dict_Type,
                   DttmExtracted)) %&gt;% #Purge the none informative columns
  dplyr::slice(1:nrow(football_table)-1) %&gt;% # Get rid of the last row
  dplyr::add_tally()#Filter out team 

#Remove team
minus_team &lt;- ftball_reduced %&gt;% 
  dplyr::select(!contains("Team"))

# Convert all fields to integer
minus_team &lt;- data.frame(sapply(minus_team, as.integer))
# Bind back together

football_table &lt;- cbind(Team=ftball_reduced$Team, minus_team)
```



---
### Viewing the data on a scatter chart to explore key metrics

```r
plot &lt;- ggplot(football_table, 
       aes(x=W, y=Pts, color=factor(Team))) + geom_point() +
  theme_minimal()

ggplotly(plot)
```

<div id="htmlwidget-ceb31574f017a62ebbbe" style="width:100%;height:55%;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-ceb31574f017a62ebbbe">{"x":{"data":[{"x":[1],"y":[8],"text":"W:  1<br />Pts:  8<br />factor(Team): Barnsley","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(248,118,109,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(248,118,109,1)"}},"hoveron":"points","name":"Barnsley","legendgroup":"Barnsley","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[22],"text":"W:  6<br />Pts: 22<br />factor(Team): Birmingham","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(237,129,62,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(237,129,62,1)"}},"hoveron":"points","name":"Birmingham","legendgroup":"Birmingham","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[23],"text":"W:  6<br />Pts: 23<br />factor(Team): Blackburn","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(222,140,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(222,140,0,1)"}},"hoveron":"points","name":"Blackburn","legendgroup":"Blackburn","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[7],"y":[24],"text":"W:  7<br />Pts: 24<br />factor(Team): Blackpool","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(205,150,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(205,150,0,1)"}},"hoveron":"points","name":"Blackpool","legendgroup":"Blackpool","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[11],"y":[37],"text":"W: 11<br />Pts: 37<br />factor(Team): Bournemouth","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(183,159,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(183,159,0,1)"}},"hoveron":"points","name":"Bournemouth","legendgroup":"Bournemouth","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[5],"y":[19],"text":"W:  5<br />Pts: 19<br />factor(Team): Bristol City","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(157,167,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(157,167,0,1)"}},"hoveron":"points","name":"Bristol City","legendgroup":"Bristol City","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[3],"y":[12],"text":"W:  3<br />Pts: 12<br />factor(Team): Cardiff","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(124,174,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(124,174,0,1)"}},"hoveron":"points","name":"Cardiff","legendgroup":"Cardiff","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[8],"y":[27],"text":"W:  8<br />Pts: 27<br />factor(Team): Coventry","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(73,181,0,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(73,181,0,1)"}},"hoveron":"points","name":"Coventry","legendgroup":"Coventry","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[3],"y":[5],"text":"W:  3<br />Pts:  5<br />factor(Team): Derby","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,186,56,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,186,56,1)"}},"hoveron":"points","name":"Derby","legendgroup":"Derby","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[10],"y":[32],"text":"W: 10<br />Pts: 32<br />factor(Team): Fulham","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,190,103,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,190,103,1)"}},"hoveron":"points","name":"Fulham","legendgroup":"Fulham","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[7],"y":[25],"text":"W:  7<br />Pts: 25<br />factor(Team): Huddersfield","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,192,139,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,192,139,1)"}},"hoveron":"points","name":"Huddersfield","legendgroup":"Huddersfield","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[2],"y":[9],"text":"W:  2<br />Pts:  9<br />factor(Team): Hull","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,193,169,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,193,169,1)"}},"hoveron":"points","name":"Hull","legendgroup":"Hull","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[24],"text":"W:  6<br />Pts: 24<br />factor(Team): Luton","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,191,196,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,191,196,1)"}},"hoveron":"points","name":"Luton","legendgroup":"Luton","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[21],"text":"W:  6<br />Pts: 21<br />factor(Team): Middlesbrough","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,187,220,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,187,220,1)"}},"hoveron":"points","name":"Middlesbrough","legendgroup":"Middlesbrough","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[24],"text":"W:  6<br />Pts: 24<br />factor(Team): Millwall","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,180,240,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,180,240,1)"}},"hoveron":"points","name":"Millwall","legendgroup":"Millwall","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[5],"y":[19],"text":"W:  5<br />Pts: 19<br />factor(Team): Nottm Forest","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(0,169,255,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(0,169,255,1)"}},"hoveron":"points","name":"Nottm Forest","legendgroup":"Nottm Forest","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[4],"y":[15],"text":"W:  4<br />Pts: 15<br />factor(Team): Peterborough","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(97,156,255,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(97,156,255,1)"}},"hoveron":"points","name":"Peterborough","legendgroup":"Peterborough","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[4],"y":[18],"text":"W:  4<br />Pts: 18<br />factor(Team): Preston","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(159,140,255,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(159,140,255,1)"}},"hoveron":"points","name":"Preston","legendgroup":"Preston","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[22],"text":"W:  6<br />Pts: 22<br />factor(Team): QPR","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(199,124,255,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(199,124,255,1)"}},"hoveron":"points","name":"QPR","legendgroup":"QPR","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[19],"text":"W:  6<br />Pts: 19<br />factor(Team): Reading","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(227,110,246,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(227,110,246,1)"}},"hoveron":"points","name":"Reading","legendgroup":"Reading","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[5],"y":[19],"text":"W:  5<br />Pts: 19<br />factor(Team): Sheff Utd","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(245,100,227,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(245,100,227,1)"}},"hoveron":"points","name":"Sheff Utd","legendgroup":"Sheff Utd","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[22],"text":"W:  6<br />Pts: 22<br />factor(Team): Stoke","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(255,97,204,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(255,97,204,1)"}},"hoveron":"points","name":"Stoke","legendgroup":"Stoke","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[6],"y":[23],"text":"W:  6<br />Pts: 23<br />factor(Team): Swansea","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(255,100,176,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(255,100,176,1)"}},"hoveron":"points","name":"Swansea","legendgroup":"Swansea","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[8],"y":[28],"text":"W:  8<br />Pts: 28<br />factor(Team): West Brom","type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(255,108,145,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(255,108,145,1)"}},"hoveron":"points","name":"West Brom","legendgroup":"West Brom","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":23.3059360730594,"r":7.30593607305936,"b":37.2602739726027,"l":37.2602739726027},"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[0.5,11.5],"tickmode":"array","ticktext":["3","6","9"],"tickvals":[3,6,9],"categoryorder":"array","categoryarray":["3","6","9"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.65296803652968,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"W","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[3.4,38.6],"tickmode":"array","ticktext":["10","20","30"],"tickvals":[10,20,30],"categoryorder":"array","categoryarray":["10","20","30"],"nticks":null,"ticks":"","tickcolor":null,"ticklen":3.65296803652968,"tickwidth":0,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(235,235,235,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"Pts","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":null,"bordercolor":null,"borderwidth":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"title":{"text":"factor(Team)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}}},"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","modeBarButtonsToAdd":["hoverclosest","hovercompare"],"showSendToCloud":false},"source":"A","attrs":{"abc35893838":{"x":{},"y":{},"colour":{},"type":"scatter"}},"cur_data":"abc35893838","visdat":{"abc35893838":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot","plotly_sunburstclick"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>

---
background-image: url(man/figures/practice.jpg)
# Practice time - 15 minutes
Have a go at retrieving some Xpath data from any website. Find a data table and bring it into R with the TableR function.

---
class: inverse, middle, left, hide-logo
# Scraping raw text from websites with xpathTextR function

---

## Extracting text from the NHS Data Dictionary website


```r
acc_type &lt;- nhs_data_table %&gt;% 
  filter(link_name=='ACCOMMODATION TYPE')
#browseURL(acc_type$full_url)

# Specify the custom element obtained from the inspect function
xpath &lt;- '//*[@id="element_accommodation_type"]/div/p'
result_list &lt;- NHSDataDictionaRy::xpathTextR(url=acc_type$full_url, 
                              xpath = xpath)

str(result_list)
```

```
## List of 6
##  $ result          : chr "ACCOMMODATION STATUS CODE will be replaced with ACCOMMODATION TYPE, which is the most recent approved national "| __truncated__
##  $ website_passed  : chr "https://datadictionary.nhs.uk/data_elements/accommodation_type.html"
##  $ xpath_passed    : chr "//*[@id=\"element_accommodation_type\"]/div/p"
##  $ html_node_result:List of 2
##   ..$ node:&lt;externalptr&gt; 
##   ..$ doc :&lt;externalptr&gt; 
##   ..- attr(*, "class")= chr [1:2] "xml_document" "xml_node"
##  $ datetime_access : POSIXct[1:1], format: "2021-11-03 08:58:47"
##  $ person_accessed : chr "GARY.HUTSON - ASCENT"
```

---
## Cleaning the extracted text
The next stage is to clean the extracted text from the list element **result**:


```r
clean_txt &lt;- trimws(unlist(result_list$result)) %&gt;% 
  gsub("[\r\n]", "",.) 

print(clean_txt)
```

```
## [1] "ACCOMMODATION STATUS CODE will be replaced with ACCOMMODATION TYPE, which is the most recent approved national information standard to describe the required definition."
```

Now you could use the inbuilt string functions in the package to strip the text further:


```r
# Extracted string
NHSDataDictionaRy::left_xl(clean_txt, 20)
```

```
## [1] "ACCOMMODATION STATUS"
```

---
background-image: url(man/figures/practice.jpg)
# Practice time - 10 minutes
Have a go at finding a component from the NHS Data Dictionary, or other website, to test out this functionality.

---

# Scraping a list of links from a website
The NHSDataDictionaRy tool provides functionality for scraping a webpage to extract all the urls from the page. This is how it can be implemented:


```r
url &lt;- "https://datadictionary.nhs.uk/data_sets_overview.html"
results &lt;- NHSDataDictionaRy::linkScrapeR(url, SSL_needed = FALSE)
head(results %&gt;% 
       dplyr::select(url), 10)
```

```
## # A tibble: 10 x 1
##    url                                                                 
##    &lt;chr&gt;                                                               
##  1 #wh_topic_body                                                      
##  2 https://www.nhs.uk                                                  
##  3 index.html                                                          
##  4 about/about.html                                                    
##  5 help/help_and_guidance.html                                         
##  6 data_sets_overview.html                                             
##  7 data_elements_overview.html#dataElement_overview                    
##  8 attributes_overview.html#attribute_overview                         
##  9 classes_overview.html#class_overview                                
## 10 nhs_business_definitions_overview.html#business_definitions_overview
```

---

# Capstone Project - Working through the whole solution

We will now utilise the tool to scrape the levels of COVID-19 by country, as I know it has been a hard year and we are getting there:

## Data Preparation


```r
xpath &lt;- '//*[@id="main_table_countries_today"]'
url &lt;- "https://www.worldometers.info/coronavirus/"

covid19 &lt;- NHSDataDictionaRy::tableR(url=url, xpath=xpath) %&gt;% 
  select(-c("#"))

c19_reduced &lt;- covid19 %&gt;% 
  select(TotalCases, TotalRecovered, TotalDeaths, TotalTests, NewCases, `Country,Other`, Continent)
# Map through the data frame and strip out the comman from the text and make numeric
```

---

## Data Preparation (continued)

The data returns character strings, so I will use the first 4 columns from my selection above:


```r
c19_numerics &lt;- c19_reduced[,1:5] %&gt;% 
  purrr::map_dfr(~ as.numeric(gsub(",", "", .))) %&gt;% #Get rid of 
  purrr::map_dfr(~as.numeric(gsub("+", "", .))) %&gt;% # Get rid of + symbol
  #Fill in NAs if they are zero
  purrr::map_dfr(~ ifelse(is.na(.),0, .))
```

```
## Warning in .f(.x[[i]], ...): NAs introduced by coercion
```

We then ***purrr::map_dfr*** over the data frame to convert to numeric and strip out the commas and then to fill in the NA values with a zero if they are missing. 


---
## Data Preparation (continued)

Finally, I will join the data back on to the original frame to bring back in the country:


```r
c19_final &lt;- cbind(
  c19_reduced &lt;- c19_reduced %&gt;% dplyr::select(`Country,Other`, Continent),
  c19_numerics
) %&gt;% 
  dplyr::rename(Country=`Country,Other`) %&gt;% 
  dplyr::filter(Country!="",
                !str_detect(Country, "Total"), 
                Country!="World")
```

Here we:

- Used cbind base R function to combine the reduced dataset and the numerical dataframe
- We renamed the Country field
- We then filtered out the blank countries and those where there is a total column

---
## The final dataset
This is the final dataset ready to be worked on with R:


```r
print(head(c19_final,5))
```

```
##         Country     Continent TotalCases TotalRecovered TotalDeaths TotalTests
## 1 North America North America   56441733       45210670     1151451          0
## 2          Asia          Asia   79591311       76678696     1174438          0
## 3 South America South America   38442213       36577168     1171024          0
## 4        Europe        Europe   64958366       58371504     1309941          0
## 5        Africa        Africa    8581186        7920450      219105          0
##   NewCases
## 1     3687
## 2    24275
## 3      138
## 4    37922
## 5        0
```
  
With this dataset we will create some visuals. We could even store these in a data table with a time stamp over time to get the relevant days COVID-19 results.

---
## Visualising the results

We'll use our final data frame that we generated to create some visuals of the COVID rates, perhaps a scatter chart would be good for this purpose to see the ratio of total cases to total deaths.


```r
highest_cases &lt;- c19_final %&gt;% 
  dplyr::arrange(desc(TotalCases)) %&gt;% 
  dplyr::filter(Country!=Continent) 
```

On the next slide we will visualise the results:

---

## Visualising the results


```r
options(scipen=999)
ggplot(highest_cases, aes(TotalDeaths,TotalCases)) + 
 geom_point(aes(color=factor(Country))) + theme_minimal() +
  theme(legend.position = "none") +
  labs(x="Total COVID-19 Deaths", y="Total COVID-19 Cases")
```

&lt;img src="NHSDataDictionaRyMarkdownFinalVersion_files/figure-html/graph_the_results-1.png" width="30%" /&gt;

---
class: inverse, middle, left, hide-logo
# Questions?






    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"seal": false,
"self_contained": true,
"highlightLanguage": "r",
"countIncrementalSlides": false,
"ratio": "16:9"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<style>
.logo {
  background-image: url(../man/figures/NHSRComm.png);
  background-size: contain;
  background-repeat: no-repeat;
  position: absolute;
  top: 1em;
  right: 1em;
  width: 110px;
  height: 128px;
  z-index: 0;
}
</style>

<script>
document
  .querySelectorAll(
    '.remark-slide-content' +
    ':not(.title-slide)' +
    // add additional classes to exclude here, e.g.
    //':not(.inverse)' +
    ':not(.hide-logo)'
  )
  .forEach(el => {
    el.innerHTML += '<div class="logo"></div>';
  });
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
